<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>종합소득세 간편 계산기 - Ver 2.3</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Base Setup */
    body { font-family: 'Inter', sans-serif; background-color: #f9fafb; }
    .collapsible-header { cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
    .collapsible-icon { transition: transform 0.3s ease-in-out; }
    .collapsible-icon.rotated { transform: rotate(90deg); }
    .copy-button-active { background-color: #9ca3af !important; pointer-events: none; }
    .modal-overlay { position: fixed; inset: 0; background-color: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; }
    .modal-container { background-color: white; padding: 30px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); max-width: 90%; max-height: 90%; overflow-y: auto; position: relative; }
    .message-box { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background-color: #ef4444; color: #fff; padding: 12px 24px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 2000; opacity: 0; visibility: hidden; transition: opacity .3s, visibility .3s; }
    .message-box.show { opacity: 1; visibility: visible; }
    
    /* Sleek Redesign UI */
    .app-card {
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.1);
        border: 1px solid #e5e7eb;
    }
    .input-field {
        transition: all 0.2s ease-in-out;
        border: 1px solid #d1d5db;
        padding: 0.8rem;
    }
    .input-field:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.4);
        background-color: #eff6ff;
    }
    .button-primary {
        background: linear-gradient(135deg, #2563eb, #1e40af);
        transition: all 0.3s ease-in-out;
        box-shadow: 0 8px 15px rgba(59, 130, 246, 0.4);
    }
    .button-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(30, 64, 175, 0.5);
    }
    .button-secondary {
        background-color: #f3f4f6;
        color: #4b5563;
        border: 1px solid #d1d5db;
        transition: all 0.2s ease-in-out;
    }
    .button-secondary:hover {
        background-color: #e5e7eb;
    }
    .grouped-input-box {
        background-color: #f7f9fc;
        border: 1px solid #e0e7ff;
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.03);
    }
    #result {
        border: none;
        background-color: #ffffff;
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.08);
    }
    #summaryBox {
        background-color: #e0f2fe;
        border: 1px solid #93c5fd;
        box-shadow: 0 8px 15px rgba(59, 130, 246, 0.15);
    }
    .final-result-value {
        font-weight: 800;
        color: #1d4ed8;
    }
  </style>
</head>
<body class="bg-gray-50 p-4 pt-8">
  <div class="bg-white rounded-3xl app-card w-full max-w-lg p-7 sm:p-9 mx-auto">
    <h1 class="text-3xl font-extrabold text-center text-gray-800 mb-2">종합소득세 간편 계산기</h1>
    <p class="text-center text-gray-500 font-semibold mb-7 cursor-pointer" onclick="showLogicModal()">Ver 2.3</p>

    <!-- 입력 폼 -->
    <div id="calculatorForm" class="space-y-5">
      <!-- 총수입금액 -->
      <div>
        <label for="grossIncome" class="block text-sm font-medium text-gray-700 mb-1">총수입금액</label>
        <div class="relative rounded-lg shadow-sm">
          <input type="text" id="grossIncome" class="input-field block w-full rounded-lg border-gray-300 shadow-sm transition" placeholder="예: 50,000,000" oninput="formatNumber(this)">
          <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none"><span class="text-gray-500 sm:text-sm">원</span></div>
        </div>
      </div>

      <!-- 현재/실질 소득률 -->
      <div class="flex space-x-4">
        <div class="flex-1">
          <label for="currentIncomeRate" class="block text-sm font-medium text-gray-700 mb-1">현재 소득률</label>
          <div class="relative rounded-lg shadow-sm">
            <input type="number" step="0.1" id="currentIncomeRate" class="input-field block w-full rounded-lg border-gray-300 shadow-sm transition" placeholder="예: 40" min="0" max="100">
            <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none"><span class="text-gray-500 sm:text-sm">%</span></div>
          </div>
        </div>
        <div class="flex-1">
          <label for="effectiveIncomeRate" class="block text-sm font-medium text-gray-700 mb-1">실질 소득률</label>
          <div class="relative rounded-lg shadow-sm">
            <input type="number" step="0.1" id="effectiveIncomeRate" class="input-field block w-full rounded-lg border-gray-300 shadow-sm transition" placeholder="예: 40" min="0" max="100">
            <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none"><span class="text-gray-500 sm:text-sm">%</span></div>
          </div>
        </div>
      </div>

      <!-- 목표 소득률 / 필요경비 -->
      <div class="flex space-x-4">
        <div class="flex-1">
          <label for="targetIncomeRate" class="block text-sm font-medium text-gray-700 mb-1">목표 소득률</label>
          <div class="relative rounded-lg shadow-sm">
            <input type="number" step="0.1" id="targetIncomeRate" class="input-field block w-full rounded-lg border-gray-300 shadow-sm transition" placeholder="예: 40" min="0" max="100">
            <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none"><span class="text-gray-500 sm:text-sm">%</span></div>
          </div>
        </div>
        <div class="flex-1">
          <label for="requiredExpenseInput" class="block text-sm font-medium text-gray-700 mb-1">필요경비</label>
          <div class="relative rounded-lg shadow-sm">
            <input type="text" id="requiredExpenseInput" class="input-field block w-full rounded-lg border-gray-300 shadow-sm transition" placeholder="예: 500" oninput="formatNumber(this)">
            <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none"><span class="text-gray-500 sm:text-sm">만</span></div>
          </div>
        </div>
      </div>

      <!-- 그 외 소득 -->
      <div class="space-y-3 p-4 rounded-xl grouped-input-box">
        <label class="block text-sm font-semibold text-gray-800 border-b border-gray-200 pb-2">그 외 소득 (사업/부동산/금융/기타)</label>
        <div class="space-y-3">
          <div>
            <label for="otherBusinessIncome" class="block text-xs font-medium text-gray-600 mb-1">1) 그 외 사업소득금액</label>
            <div class="relative rounded-md shadow-sm">
              <input type="text" id="otherBusinessIncome" class="input-field block w-full rounded-lg border-gray-300 shadow-sm transition p-2.5" placeholder="예: 1,000,000" oninput="formatNumber(this)">
              <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none"><span class="text-gray-500 text-xs">원</span></div>
            </div>
          </div>
          <div>
            <label for="realEstateIncome" class="block text-xs font-medium text-gray-600 mb-1">2) 부동산 소득금액</label>
            <div class="relative rounded-md shadow-sm">
              <input type="text" id="realEstateIncome" class="input-field block w-full rounded-lg border-gray-300 shadow-sm transition p-2.5" placeholder="예: 500,000" oninput="formatNumber(this)">
              <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none"><span class="text-gray-500 text-xs">원</span></div>
            </div>
          </div>
          <div>
            <label for="interestDividendIncome" class="block text-xs font-medium text-gray-600 mb-1">3) 이자·배당소득금액</label>
            <div class="relative rounded-md shadow-sm">
              <input type="text" id="interestDividendIncome" class="input-field block w-full rounded-lg border-gray-300 shadow-sm transition p-2.5" placeholder="예: 2,400,000" oninput="formatNumber(this)">
              <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none"><span class="text-gray-500 text-xs">원</span></div>
            </div>
          </div>
          <div>
            <label for="otherMiscIncome" class="block text-xs font-medium text-gray-600 mb-1">4) 그 외 소득금액 (1–3에 해당하지 않는 소득)</label>
            <div class="relative rounded-md shadow-sm">
              <input type="text" id="otherMiscIncome" class="input-field block w-full rounded-lg border-gray-300 shadow-sm transition p-2.5" placeholder="예: 300,000" oninput="formatNumber(this)">
              <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none"><span class="text-gray-500 text-xs">원</span></div>
            </div>
          </div>
        </div>
      </div>

      <!-- 소득공제 / 세액공제 -->
      <div class="flex space-x-4">
        <div class="flex-1">
          <label for="deductions" class="block text-sm font-medium text-gray-700 mb-1">소득공제</label>
          <div class="relative rounded-lg shadow-sm">
            <input type="text" id="deductions" class="input-field block w-full rounded-lg border-gray-300 shadow-sm transition" placeholder="예: 14,000,000" oninput="formatNumber(this)">
            <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none"><span class="text-gray-500 sm:text-sm">원</span></div>
          </div>
        </div>
        <div class="flex-1">
          <label for="taxCredits" class="block text-sm font-medium text-gray-700 mb-1">세액공제</label>
          <div class="relative rounded-lg shadow-sm">
            <input type="text" id="taxCredits" class="input-field block w-full rounded-lg border-gray-300 shadow-sm transition" placeholder="예: 150,000" oninput="formatNumber(this)">
            <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none"><span class="text-gray-500 sm:text-sm">원</span></div>
          </div>
        </div>
      </div>

      <!-- 중간예납 / 원천납부 -->
      <div class="flex space-x-4">
        <div class="flex-1">
          <label for="interimPrepayment" class="block text-sm font-medium text-gray-700 mb-1">중간예납</label>
          <div class="relative rounded-lg shadow-sm">
            <input type="text" id="interimPrepayment" class="input-field block w-full rounded-lg border-gray-300 shadow-sm transition" placeholder="예: 50,000" oninput="formatNumber(this)">
            <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none"><span class="text-gray-500 sm:text-sm">원</span></div>
          </div>
        </div>
        <div class="flex-1">
          <label for="withholdingTax" class="block text-sm font-medium text-gray-700 mb-1">원천납부</label>
          <div class="relative rounded-lg shadow-sm">
            <input type="text" id="withholdingTax" class="input-field block w-full rounded-lg border-gray-300 shadow-sm transition" placeholder="예: 100,000" oninput="formatNumber(this)">
            <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none"><span class="text-gray-500 sm:text-sm">원</span></div>
          </div>
        </div>
      </div>
      
      <!-- 버튼 -->
      <div class="flex space-x-4 pt-4">
        <button onclick="calculateTax()" class="w-full text-white font-bold py-3.5 px-4 rounded-lg button-primary">세금 계산하기</button>
        <button onclick="resetCalculator()" class="w-full font-bold py-3.5 px-4 rounded-lg button-secondary">초기화</button>
      </div>
    </div>

    <!-- 계산 결과 -->
    <div id="result" class="mt-8 p-6 rounded-xl hidden">
      <div class="collapsible-header" onclick="toggleResult()">
        <h3 class="text-xl font-bold text-gray-800">상세 계산 결과</h3>
        <span id="resultIcon" class="collapsible-icon transform transition-transform duration-300 text-gray-500">&#9654;</span>
      </div>
      <div id="resultDetails" class="space-y-3 pt-4 border-t border-gray-100 mt-2 hidden">
        <div class="flex justify-between items-center text-sm font-medium text-gray-600"><span>총수입금액</span><span id="enteredGrossIncome" class="text-gray-900 font-bold"></span></div>
        <div class="flex justify-between items-center text-sm font-medium text-gray-600"><span>소득률</span><span id="enteredIncomeRate" class="text-gray-900 font-bold"></span></div>
        <div id="businessIncomeContainer" class="flex justify-between items-center text-sm font-medium text-gray-600 hidden"><span>사업소득금액</span><span id="businessIncome" class="text-gray-900 font-bold"></span></div>

        <!-- 그 외 소득 합계/상세 -->
        <div id="otherIncomeSection" class="space-y-1 hidden">
          <div class="flex justify-between items-center text-sm font-semibold text-gray-700 border-t border-gray-200 pt-2">
            <span>그 외 소득 (합계)</span><span id="enteredOtherIncomeTotal" class="text-gray-900 font-bold"></span>
          </div>
          <div id="rowOtherBiz" class="flex justify-between items-center text-xs font-medium text-gray-500 hidden"><span>ㆍ그 외 사업소득금액</span><span id="valOtherBiz" class="text-gray-700 font-semibold"></span></div>
          <div id="rowRealEstate" class="flex justify-between items-center text-xs font-medium text-gray-500 hidden"><span>ㆍ부동산 소득금액</span><span id="valRealEstate" class="text-gray-700 font-semibold"></span></div>
          <div id="rowInterestDiv" class="flex justify-between items-center text-xs font-medium text-gray-500 hidden"><span>ㆍ이자 및 배당소득금액</span><span id="valInterestDiv" class="text-gray-700 font-semibold"></span></div>
          <div id="rowOtherMisc" class="flex justify-between items-center text-xs font-medium text-gray-500 hidden"><span>ㆍ그 외 소득금액(기타)</span><span id="valOtherMisc" class="text-gray-700 font-semibold"></span></div>
        </div>

        <div class="flex justify-between items-center text-sm font-medium text-gray-600 border-t border-gray-200 pt-2"><span>종합소득금액</span><span id="calculatedIncome" class="text-gray-900 font-bold"></span></div>
        <div class="flex justify-between items-center text-sm font-medium text-gray-600"><span>소득공제</span><span id="enteredDeductions" class="text-gray-900 font-bold"></span></div>
        <div class="flex justify-between items-center text-sm font-medium text-gray-600"><span>과세표준(합산분)</span><span id="taxableBase" class="text-gray-900 font-bold"></span></div>

        <div class="flex justify-between items-center text-sm font-medium text-gray-600 pt-2 border-t border-gray-200">
          <span>종합과세 방식 산출세액 (①)</span><span id="calculatedTax" class="text-gray-900 font-bold"></span>
        </div>
        <div class="flex justify-between items-center text-sm font-medium text-gray-600">
          <span>분리과세 방식 산출세액 (②)</span><span id="compare2Tax" class="text-gray-900 font-bold"></span>
        </div>

        <div class="flex justify-between items-center text-sm font-medium text-gray-600 pt-2 border-t border-gray-200"><span>최저한세 기준금액</span><span id="minimumTaxAmount" class="text-gray-900 font-bold"></span></div>
        <div class="flex justify-between items-center text-sm font-medium text-gray-600"><span>실제 적용 세액공제액</span><span id="appliedTaxCredits" class="text-gray-900 font-bold"></span></div>
        <div class="flex justify-between items-center text-sm font-medium text-gray-600"><span>농어촌특별세</span><span id="ruralTax" class="text-gray-900 font-bold"></span></div>
        <hr class="border-gray-300 mt-3" />
        <div class="flex justify-between items-center text-xl font-bold text-gray-800 pt-2"><span>결정세액</span><span id="finalTax" class="final-result-value text-blue-700 text-2xl"></span></div>
        <div class="flex justify-between items-center text-sm font-medium text-gray-600 mt-4"><span>중간예납</span><span id="enteredInterimPrepayment" class="text-gray-900 font-bold"></span></div>
        <div class="flex justify-between items-center text-sm font-medium text-gray-600"><span>원천납부</span><span id="enteredWithholdingTax" class="text-gray-900 font-bold"></span></div>
        <hr class="border-gray-300 mt-3" />
        <div class="flex justify-between items-center text-lg font-bold text-gray-800"><span>차감 납부 소득세</span><span id="netIncomeTax" class="final-result-value text-blue-700 text-xl"></span></div>
        <div class="flex justify-between items-center text-lg font-bold text-gray-800"><span>차감 납부 지방세</span><span id="netLocalTax" class="final-result-value text-blue-700 text-xl"></span></div>
      </div>
    </div>

    <!-- 총괄 요약 -->
    <div id="summaryBox" class="mt-8 p-6 rounded-xl summary-box hidden">
      <h3 class="text-xl font-bold text-blue-800 mb-4 border-b border-blue-300 pb-2">총괄 요약</h3>
      <div class="space-y-3">
        <div id="effectivePreTaxIncomeSummary" class="flex justify-between items-center text-base font-bold text-gray-800"></div>
        <div id="effectivePostTaxIncomeSummary" class="flex justify-between items-center text-base font-bold text-gray-800"></div>
        <div id="totalTaxSummary" class="flex justify-between items-center text-base font-bold text-gray-800"></div>
        <div class="flex justify-between items-center text-sm font-medium text-gray-600 pt-2 border-t border-blue-200"><span>소득률</span><span id="summaryIncomeRate" class="text-blue-900 font-bold text-lg"></span></div>
        <div id="requiredExpenseContainer" class="flex justify-between items-center text-sm font-medium text-gray-600 hidden"><span>필요경비</span><span id="requiredExpense" class="text-blue-900 font-bold text-lg"></span></div>
        <div id="taxSummaryBeforeAfterContainer">
          <div class="flex justify-between items-center text-sm font-medium text-gray-600"><span>공제 전 세금</span><span id="summaryTaxBefore" class="text-blue-900 font-bold text-lg"></span></div>
          <div class="flex justify-between items-center text-sm font-medium text-gray-600"><span>공제 후 세금</span><span id="summaryTaxAfter" class="text-blue-900 font-bold text-lg"></span></div>
        </div>
        <div id="taxSummaryTotalContainer" class="hidden">
          <div class="flex justify-between items-center text-sm font-medium text-gray-600"><span>세금</span><span id="summaryTaxTotal" class="text-blue-900 font-bold text-lg"></span></div>
        </div>
        <div id="summaryTaxCreditsContainer" class="flex justify-between items-center text-sm font-medium text-gray-600"><span>세액공제액</span><span id="summaryAppliedTaxCredits" class="text-blue-900 font-bold text-lg"></span></div>
      </div>
      <button id="copyButton" onclick="copySummary()" class="w-full text-white font-bold py-3 px-4 rounded-lg button-primary mt-6">결과 복사하기</button>
    </div>
  </div>

  <!-- 로직 모달 -->
  <div id="logicModal" class="modal-overlay hidden" onclick="closeLogicModal(event)">
    <div class="modal-container">
      <h4 class="text-xl font-bold text-center text-gray-800 mb-4">계산 로직(실무형)</h4>
      <div class="space-y-4 text-gray-700 text-sm">
        <p>1. <strong>종합소득금액(합산분)</strong> = (총수입×최종 소득률) + [그 외 사업(1)] + [부동산(2)] + [기타(4)] + <u>max(0, 금융(3)−2,000만)</u></p>
        <p>2. <strong>과세표준(합산분)</strong> = max(0, 합산분 종합소득금액 − 소득공제)</p>
        <p>3. <strong>합산분 산출세액</strong> = 누진세율(과표×세율 − 누진공제)</p>
        <p>4. <strong>분리과세(금융)</strong> = min(금융(3), 2,000만) × 14%</p>
        <p>5. <strong>종합과세 방식 산출세액 (①)</strong> = 3번 합산분 산출세액 + 4번(분리과세 14%)</p>
        <p>6. <strong>분리과세 방식 산출세액 (②)</strong> = 금융(3)×14% + Tax(다른 소득 − 소득공제)</p>
        <p>7. <strong>종합소득 산출세액</strong> = max(①, ②)</p>
        <p class="font-bold text-blue-700">
          8. <strong>사업 최저한세 (핵심 로직)</strong>: 
          <u>메인사업+그외사업(1)+부동산(2)</u> ÷ 
          <u>전체 종합소득(메인+1+2+금융+기타)</u> 비율로 
          <strong>7번 종합소득 산출세액</strong>을 안분 후 35%/45% 비교 적용
        </p>
        <p>9. <strong>세액공제</strong>: 사업분에만 적용(최저한세 하회 불가), 분리과세분 제외</p>
        <p>10. <strong>결정세액</strong> = (비사업분 + 사업분 비교적용 후 − 공제)</p>
        <p>11. <strong>농특세</strong> = 적용 세액공제 × 20%</p>
        <p>12. <strong>차감 납부</strong>: 소득세 = 결정세액 − (중간예납+원천), 지방세 = (결정세액 − 원천)×10%</p>
        <button onclick="closeLogicModal(event)" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-md transition-colors duration-200 mt-4">닫기</button>
      </div>
    </div>
  </div>

  <!-- 메시지 박스 -->
  <div id="messageBox" class="message-box"></div>

  <script>
    /* ===== 공통 상수 및 유틸리티 함수 ===== */
    const SEP_THRESHOLD = 20_000_000;
    const FIN_RATE = 0.14;
    const KRW = new Intl.NumberFormat('ko-KR', { style: 'currency', currency: 'KRW' });
    const brackets = [
      { rate: 0.06, threshold: 14_000_000,  pd: 0 },
      { rate: 0.15, threshold: 50_000_000,  pd: 1_260_000 },
      { rate: 0.24, threshold: 88_000_000,  pd: 5_760_000 },
      { rate: 0.35, threshold: 150_000_000, pd: 15_440_000 },
      { rate: 0.38, threshold: 300_000_000, pd: 19_940_000 },
      { rate: 0.40, threshold: 500_000_000, pd: 25_940_000 },
      { rate: 0.42, threshold: 1_000_000_000, pd: 35_940_000 },
      { rate: 0.45, threshold: Infinity,    pd: 65_940_000 },
    ];

    const el  = (id) => document.getElementById(id);
    const show = (id, visible) => el(id).classList.toggle('hidden', !visible);

    const formatNumber = (input) => {
      let raw = input.value || '';
      const startsWithMinus = raw.startsWith('-');
      let digits = raw.replace(/[^\d]/g, '');

      if (digits === '') {
        input.value = startsWithMinus ? '-' : '';
        return;
      }
      
      const num = Number(digits);
      let formatted = new Intl.NumberFormat('ko-KR').format(num);
      if (startsWithMinus) formatted = `-${formatted}`;
      input.value = formatted;
    };
    
    const showMessage = (msg) => {
      const box = el('messageBox');
      box.innerText = msg;
      box.classList.add('show');
      setTimeout(() => box.classList.remove('show'), 3000);
    };

    const toNum = (id) => parseFloat((el(id).value || '').replace(/,/g,'')) || 0;
    const setText = (id, val) => { el(id).innerText = val; };
    const won = (n) => KRW.format(n);
    const formatSummaryAmount = (amount) => {
      const x = Math.round(amount);
      return Math.abs(x) >= 100_000_000 ? (x/100_000_000).toFixed(2) + '억' : (x/10_000).toFixed(0) + '만';
    };

    const taxProgressive = (base) => {
      const x = Math.max(0, base);
      for (const b of brackets) {
        if (x <= b.threshold) return Math.max(0, x * b.rate - b.pd);
      }
      return Math.max(0, x * 0.45 - 65_940_000);
    };

    const minTax = (amount) => amount <= 30_000_000
      ? amount * 0.35
      : 30_000_000 * 0.35 + (amount - 30_000_000) * 0.45;

    const toggleResult = () => {
      const hidden = el('resultDetails').classList.contains('hidden');
      show('resultDetails', hidden);
      el('resultIcon').classList.toggle('rotated', hidden);
    };

    /* ===== 메인 계산 로직 ===== */
    function calculateTax(){
      const copyBtn = el('copyButton');
      copyBtn.innerText = '결과 복사하기';
      copyBtn.classList.remove('bg-gray-400','hover:bg-gray-400','copy-button-active');
      copyBtn.classList.add('bg-blue-600','hover:bg-blue-700');

      const grossIncome          = toNum('grossIncome');
      const otherBusinessIncome  = toNum('otherBusinessIncome');
      const realEstateIncome     = toNum('realEstateIncome');
      const interestDividendIncome = toNum('interestDividendIncome');
      const otherMiscIncome      = toNum('otherMiscIncome');
      const otherIncomeTotal     = otherBusinessIncome + realEstateIncome + interestDividendIncome + otherMiscIncome;

      const deductions       = toNum('deductions');
      const taxCredits       = toNum('taxCredits');
      const interimPrepayment = toNum('interimPrepayment');
      const withholdingTax   = toNum('withholdingTax');

      const currentIncomeRate   = parseFloat(el('currentIncomeRate').value);
      const effectiveIncomeRate = parseFloat(el('effectiveIncomeRate').value);
      const targetIncomeRateInput = parseFloat(el('targetIncomeRate').value);
      const requiredExpenseInputRaw = (el('requiredExpenseInput').value || '').replace(/,/g,'');
      const requiredExpenseInput = requiredExpenseInputRaw === '' ? null : parseFloat(requiredExpenseInputRaw);

      if (grossIncome <= 0) { showMessage('총수입금액을 입력해주세요.'); return; }
      if (isNaN(targetIncomeRateInput) && requiredExpenseInput == null) { showMessage('목표 소득률 또는 필요경비를 입력해야 합니다.'); return; }
      if (requiredExpenseInput != null && (currentIncomeRate == null || isNaN(currentIncomeRate))) { showMessage('필요경비 입력을 위해서는 현재 소득률이 필요합니다.'); return; }

      let finalIncomeRate;
      if (requiredExpenseInput != null){
        const reqExpenseKRW = requiredExpenseInput * 10_000;
        finalIncomeRate = (currentIncomeRate || 0) - (reqExpenseKRW / grossIncome) * 100;
      } else {
        finalIncomeRate = targetIncomeRateInput;
      }
      finalIncomeRate = Math.max(0, Math.min(100, Number(finalIncomeRate || 0)));

      const calc = (credits) => {
        const businessIncome = grossIncome * (finalIncomeRate / 100);

        // 금융소득: 2,000만 초과분은 합산, 2,000만 이하는 14% 분리
        const finSeparated = Math.min(interestDividendIncome, SEP_THRESHOLD);
        const finExcess    = Math.max(0, interestDividendIncome - SEP_THRESHOLD);

        // 합산분 종합소득 (메인사업 + 1 + 2 + 4 + 금융초과분)
        const aggregatedIncome =
          businessIncome + otherBusinessIncome + realEstateIncome + otherMiscIncome + finExcess;

        // 합산분 과세표준
        const taxableBaseAggregated = Math.max(0, aggregatedIncome - deductions);

        // 합산분 산출세액 (누진세)
        const aggregatedTax = taxProgressive(taxableBaseAggregated);

        // 금융 2,000만까지 14% 분리
        const separatedTax14 = finSeparated * FIN_RATE;

        // ① 종합과세 방식 산출세액 = 합산분 + 분리과세(14%)
        const tax1_total = aggregatedTax + separatedTax14;

        // ② 분리과세 방식 산출세액
        const otherComprehensiveIncome = businessIncome + otherBusinessIncome + realEstateIncome + otherMiscIncome;
        const otherTaxableBase         = Math.max(0, otherComprehensiveIncome - deductions);
        const tax2_total               = interestDividendIncome * FIN_RATE + taxProgressive(otherTaxableBase);

        // 종합소득 산출세액 = max(①, ②)
        const selectedTaxBase = Math.max(tax1_total, tax2_total);

        // 최저한세 대상 소득(분자) = 메인사업 + 그외사업(1) + 부동산(2)
        const minTaxBaseIncome = businessIncome + otherBusinessIncome + realEstateIncome;

        // 전체 종합소득(분모) = 메인사업 + 1 + 2 + 금융 + 기타(4)
        const totalComprehensiveIncome =
          businessIncome + otherBusinessIncome + realEstateIncome + interestDividendIncome + otherMiscIncome;

        const minTaxShare = (totalComprehensiveIncome > 0 && minTaxBaseIncome > 0)
          ? (minTaxBaseIncome / totalComprehensiveIncome)
          : 0;

        // 종합소득 산출세액 중 사업분 세액
        const businessPortionTax   = selectedTaxBase * minTaxShare;
        const nonBusinessPortionTax = selectedTaxBase - businessPortionTax;

        // 최저한세(35%/45%) 비교
        const minTaxAmount  = minTax(businessPortionTax);
        const businessAfterMin = Math.max(businessPortionTax, minTaxAmount);
        
        // 세액공제는 사업분에만, 최저한세 하회 불가
        const appliedTaxCredits = Math.min(credits, Math.max(0, businessAfterMin - minTaxAmount));
        const ruralTax          = appliedTaxCredits * 0.2;

        // 결정세액 = 비사업분 + (사업분 - 세액공제)
        const finalTax = nonBusinessPortionTax + (businessAfterMin - appliedTaxCredits);

        // 차감 납부 세액
        const netIncomeTax = finalTax - (interimPrepayment + withholdingTax);
        const netLocalTax  = (finalTax - withholdingTax) * 0.1;

        return {
          businessIncome,
          aggregatedIncome,
          taxableBaseAggregated,
          calculatedTax: tax1_total,    // ① 종합과세 방식 산출세액
          compare2Tax:   tax2_total,    // ② 분리과세 방식 산출세액
          selectedTaxBase,
          minTaxAmount,
          appliedTaxCredits,
          ruralTax,
          finalTax,
          netIncomeTax,
          netLocalTax
        };
      };

      const withCredits    = calc(taxCredits);
      const withoutCredits = calc(0);

      // 바인딩
      setText('enteredGrossIncome', won(grossIncome));
      setText('enteredIncomeRate', `${finalIncomeRate.toFixed(2)}%`);

      show('businessIncomeContainer', withCredits.businessIncome !== 0);
      if (withCredits.businessIncome !== 0) {
        setText('businessIncome', won(withCredits.businessIncome));
      }

      // 그 외 소득 섹션
      if (otherIncomeTotal !== 0){
        show('otherIncomeSection', true);
        setText('enteredOtherIncomeTotal', won(otherIncomeTotal));

        const toggleRow = (rowId, valId, val) => {
          show(rowId, val !== 0);
          if (val !== 0) setText(valId, won(val));
        };
        toggleRow('rowOtherBiz',   'valOtherBiz',   otherBusinessIncome);
        toggleRow('rowRealEstate', 'valRealEstate', realEstateIncome);
        toggleRow('rowInterestDiv','valInterestDiv',interestDividendIncome);
        toggleRow('rowOtherMisc',  'valOtherMisc',  otherMiscIncome);
      } else {
        show('otherIncomeSection', false);
      }

      setText('calculatedIncome', won(withCredits.aggregatedIncome));
      setText('enteredDeductions', won(deductions));
      setText('taxableBase', won(withCredits.taxableBaseAggregated));

      // ①, ② 각각 표시
      setText('calculatedTax', won(withCredits.calculatedTax));
      setText('compare2Tax',   won(withCredits.compare2Tax));

      setText('minimumTaxAmount',  won(withCredits.minTaxAmount));
      setText('appliedTaxCredits', won(withCredits.appliedTaxCredits));
      setText('ruralTax',          won(withCredits.ruralTax));
      setText('finalTax',          won(withCredits.finalTax));
      setText('enteredInterimPrepayment', won(interimPrepayment));
      setText('enteredWithholdingTax',    won(withholdingTax));
      setText('netIncomeTax', won(withCredits.netIncomeTax));
      setText('netLocalTax',  won(withCredits.netLocalTax));

      // 실질 요약
      const effRate = isNaN(effectiveIncomeRate) ? finalIncomeRate : effectiveIncomeRate;
      const preTax  = grossIncome * (effRate/100);
      const totalTax = (withCredits.finalTax * 1.1) + withCredits.ruralTax;
      const postTax  = preTax - totalTax;
      const postRate = ((postTax / grossIncome) * 100).toFixed(2);

      const monthlyPre  = preTax / 12;
      const monthlyPost = postTax / 12;
      el('effectivePreTaxIncomeSummary').innerHTML =
        `실질 연 세전소득 ${formatSummaryAmount(preTax)} | 월 세전소득 ${formatSummaryAmount(monthlyPre)} (${effRate.toFixed(2)}%)`;
      el('effectivePostTaxIncomeSummary').innerHTML =
        `실질 연 세후소득 ${formatSummaryAmount(postTax)} | 월 세후소득 ${formatSummaryAmount(monthlyPost)} (${postRate}%)`;
      el('totalTaxSummary').innerHTML =
        `총 세금 ${formatSummaryAmount(totalTax)} (${((totalTax/grossIncome)*100).toFixed(2)}%)`;
      setText('summaryIncomeRate', `${finalIncomeRate.toFixed(2)}%`);

      // 필요경비 요약
      const reqBox = el('requiredExpenseContainer');
      if (!isNaN(targetIncomeRateInput) && !isNaN(currentIncomeRate)){
        const req = grossIncome * ((currentIncomeRate - targetIncomeRateInput)/100);
        const rounded = Math.ceil(req/10_000)*10_000;
        show('requiredExpenseContainer', true);
        setText('requiredExpense', formatSummaryAmount(rounded));
      } else if (requiredExpenseInput != null) {
        show('requiredExpenseContainer', true);
        setText('requiredExpense', formatSummaryAmount(requiredExpenseInput*10_000));
      } else {
        show('requiredExpenseContainer', false);
      }

      // 공제 전/후 합계
      const totalTaxAfter  = withCredits.netIncomeTax + withCredits.netLocalTax + withCredits.ruralTax;
      const totalTaxBefore = withoutCredits.netIncomeTax + withoutCredits.netLocalTax + withoutCredits.ruralTax;

      if (taxCredits === 0){
        show('taxSummaryBeforeAfterContainer', false);
        show('summaryTaxCreditsContainer', false);
        show('taxSummaryTotalContainer', true);
        setText('summaryTaxTotal', formatSummaryAmount(totalTaxBefore));
      } else {
        show('taxSummaryBeforeAfterContainer', true);
        show('summaryTaxCreditsContainer', true);
        show('taxSummaryTotalContainer', false);
        setText('summaryTaxBefore', formatSummaryAmount(totalTaxBefore));
        setText('summaryTaxAfter',  formatSummaryAmount(totalTaxAfter));
        setText('summaryAppliedTaxCredits', (() => {
          const x = Math.round(withCredits.appliedTaxCredits);
          return Math.abs(x) >= 100_000_000 ? (x/100_000_000).toFixed(2)+'억' : (x/10_000).toFixed(0)+'만';
        })());
      }

      show('result', true);
      show('summaryBox', true);
    }

    function resetCalculator(){
      [
        'grossIncome','currentIncomeRate','effectiveIncomeRate','targetIncomeRate','requiredExpenseInput',
        'otherBusinessIncome','realEstateIncome','interestDividendIncome','otherMiscIncome',
        'deductions','taxCredits','interimPrepayment','withholdingTax'
      ].forEach(id => { el(id).value = ''; });

      show('result', false);
      show('summaryBox', false);
      show('resultDetails', false);
      el('resultIcon').classList.remove('rotated');
    }

    async function copySummary(){
      const incomeRate   = el('summaryIncomeRate').innerText;
      const reqContainer = el('requiredExpenseContainer');
      const requiredExp  = el('requiredExpense').innerText;
      const totalContainer = el('taxSummaryTotalContainer');

      let text = `소득률: ${incomeRate}\n`;
      if (!reqContainer.classList.contains('hidden')) text += `필요경비: ${requiredExp}\n`;
      if (!totalContainer.classList.contains('hidden')){
        text += `세금: ${el('summaryTaxTotal').innerText}`;
      } else {
        text += `공제 전 세금: ${el('summaryTaxBefore').innerText}\n`;
        text += `공제 후 세금: ${el('summaryTaxAfter').innerText}\n`;
        text += `세액공제액: ${el('summaryAppliedTaxCredits').innerText}`;
      }

      const btn = el('copyButton');
      try { await navigator.clipboard.writeText(text); }
      catch {
        const ta = document.createElement('textarea');
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
      }
      btn.innerText = '복사완료';
      btn.classList.remove('bg-blue-600','hover:bg-blue-700');
      btn.classList.add('bg-gray-400','hover:bg-gray-400','copy-button-active');
      setTimeout(()=>{
        btn.innerText = '결과 복사하기';
        btn.classList.remove('bg-gray-400','hover:bg-gray-400','copy-button-active');
        btn.classList.add('bg-blue-600','hover:bg-blue-700');
      }, 2000);
    }

    const showLogicModal = () => show('logicModal', true);
    function closeLogicModal(e){
      if (e.target === el('logicModal') || e.target.tagName === 'BUTTON'){
        show('logicModal', false);
      }
    }
  </script>
</body>
</html>
